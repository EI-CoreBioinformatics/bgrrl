BootStrap: docker 
From: centos:7
OSVersion: 7
MirrorURL: http://mirror.centos.org/centos-%{OSVERSION}/%{OSVERSION}/os/$basearch/
Include: yum wget

# maybe?
# UpdateURL: http://yum-repos.hpccluster/centos/7/updates/$basearch/

%setup


%environment
	RATT_HOME=/opt/software/ratt-code
    export RATT_HOME

	RATT_CONFIG=/opt/software/ratt-code/RATT.config_bac
	export RATT_CONFIG

    PATH=/opt/software/prokka/bin:/opt/software/samtools:/opt/software/ratt-code:/opt/miniconda/bin:$PATH
    export PATH

%post
    mkdir -p /opt/software

    ### Install your packages ###

    # update yum
    yum makecache fast && \
    yum update -y

    yum -y install git bzip2 wget which sudo vi source zlib-devel xz-devel bzip2-devel
    yum -y groupinstall "Development Tools"

	# This run of yum installs
	# - prokka perl dependencies according to github installation instructions: https://github.com/tseemann/prokka
	# i.e., these: sudo yum install git perl-Time-Piece perl-XML-Simple perl-Digest-MD5 perl-App-cpanminus git java perl-CPAN perl-Module-Build
	# - and a bunch of other libraries (perl-Env, perl-core) that seemed to be necessary during the last build (2020-01-09)
	yum -y install perl-Time-Piece perl-XML-Simple perl-Digest-MD5 perl-App-cpanminus java perl-CPAN perl-Module-Build perl-Env perl-core
	cpanm Bio::Perl

	# Miniconda
    mini_version=4.5.4
    wget https://repo.anaconda.com/miniconda/Miniconda3-${mini_version}-Linux-x86_64.sh
    bash Miniconda3-${mini_version}-Linux-x86_64.sh -b -p /opt/miniconda
    echo "PATH=/opt/miniconda/bin:\$PATH" >> /root/.bashrc
    echo "export PATH" >> /root/.bashrc
    rm Miniconda3-${mini_version}-Linux-x86_64.sh
    source /root/.bashrc
	
	# Prokka	
	git clone https://github.com/tseemann/prokka.git /opt/software/prokka
	/opt/software/prokka/bin/prokka --setupdb
	
    export PYTHONPATH=/opt/miniconda/lib/python3.6/site-packages

	# Remaining bgrrl (non-qaa) dependencies
	conda install -y -c bioconda bbmap fastqc kat unicycler spades velvet perl-velvetoptimiser seqtk emboss mummer barrnap samtools

    wget ftp://ftp.ncbi.nih.gov/toolbox/ncbi_tools/converters/by_program/tbl2asn/linux64.tbl2asn.gz
    gunzip linux64.tbl2asn.gz
    mv -v linux64.tbl2asn /usr/local/bin/tbl2asn
    chmod 777 /usr/local/bin/tbl2asn
    tbl2asn --help

	# install, build and patch ratt
	svn co "https://svn.code.sf.net/p/ratt/code/" /opt/software/ratt-code 	
	RATT_HOME=/opt/software/ratt-code
	export RATT_HOME

	PATH=/opt/software/ratt-code:$PATH
	export PATH

	cd /opt/software/ratt-code

	# patch main.ratt.pl for newer Perl versions ("patch" itself fails for some reason)
	# this hack does not seem to be required in the current setup but may be down the line!
	head -n 228 main.ratt.pl > main.ratt.pl.patched
	head -n 229 main.ratt.pl | tail -n 1 | sed "s/defined(\(.\+\))/\1/" >> main.ratt.pl.patched
	tail -n +230 main.ratt.pl >> main.ratt.pl.patched

	## diff main.ratt.pl main.ratt.pl.patched
	mv main.ratt.pl main.ratt.pl.old
	mv main.ratt.pl.patched main.ratt.pl	
	chmod a+x main.ratt.pl
	
	# patch start.ratt.sh
	head -n -2 start.ratt.sh > start.ratt.sh.patched
	tail -n 2 start.ratt.sh | head -n 1 | sed "s/^rm/rm -f/" >> start.ratt.sh.patched
	mv start.ratt.sh start.ratt.sh.old
	mv start.ratt.sh.patched start.ratt.sh
	chmod a+x start.ratt.sh

